#!/usr/bin/env nextflow
nextflow.enable.dsl=2

/* ========================================================================================
    OUTPUT DIRECTORY
======================================================================================== */
params.outdir = false

if(params.outdir){
    outdir = params.outdir
} else {
    outdir = '.'
}

/* ========================================================================================
    PARAMETERS
======================================================================================== */
params.verbose  = false
params.metadata = true // geofetch --just-metadata as default

params.geofetch_args      = ''
params.sradownloader_args = ''

/* ========================================================================================
    MESSAGES
======================================================================================== */
if (params.verbose){
    println ("[WORKFLOW] GEOFETCH ARGS: "          + params.geofetch_args)
    println ("[WORKFLOW] SRADOWNLOADER ARGS ARE: " + params.sradownloader_args)
}

/* ========================================================================================
    INPUT
======================================================================================== */
geoaccession = Channel.value(args[0])

/* ========================================================================================
    WORKFLOW
======================================================================================== */
include { GEOFETCH }       from './nf_modules/geofetch.mod.nf' params(metadata: params.metadata)
include { SRADOWNLOADER }  from './nf_modules/sradownloader.mod.nf'

workflow {
    main:
        GEOFETCH       (geoaccession, outdir, params.geofetch_args, params.verbose)
        SRADOWNLOADER  (GEOFETCH.out.sra_metadata, geoaccession, outdir, params.sradownloader_args, params.verbose)
}

workflow.onComplete {

    def msg = """\
        Pipeline execution summary
        ---------------------------
        Jobname     : ${workflow.runName}
        Completed at: ${workflow.complete}
        Duration    : ${workflow.duration}
        Success     : ${workflow.success}
        workDir     : ${workflow.workDir}
        exit status : ${workflow.exitStatus}
        """
    .stripIndent()

    sendMail(to: "${workflow.userName}@ethz.ch", subject: 'Minimal pipeline execution report', body: msg)
}
